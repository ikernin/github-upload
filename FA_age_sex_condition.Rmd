---
title: "Functional Analysis Age, Sex, Condition"
author: "Isabela Kernin"
date: "January 12, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data


```{r}
load(res_covid_shrunken.Rdata)
```



```{r}
load("age_sex_condition_s.Rdata")
```

## Age Group 1 (0-30)

### ORA

```{r}
## convert to tibble
res <- res_sex_age1s %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>%
  as_tibble()

## get entrez ids (ensembl) for the gene symbols in DE results
idx <- grch37$symbol %in% rownames(res_sex_age1s)
ids <- grch37[idx, ]

## remove duplicate IDs since gene names can map to more than one Ensembl ID since some genes change id over time
non_duplicates <- which(duplicated(ids$symbol) == FALSE)
ids <- ids[non_duplicates, ]

## merge ids with results
res_ids <- inner_join(res, ids, by=c("gene"="symbol"))

## for over-representation analysis need list of background genes(all genes tested for DE) and list of significant genes
all_genes <- as.character(res_ids$ensgene)
sig <- subset(res_ids, (padj<=0.05 & abs(log2FoldChange)>0.58))
sig_genes <- as.character(sig$ensgene)

## run GO enrichment analysis
ego <- enrichGO(gene = sig_genes, 
                universe = all_genes,
                keyType = "ENSEMBL",
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                qvalueCutoff = 0.05, 
                readable = TRUE)

## output results to a table
cluster_summary <- data.frame(ego)

##plot dotplot
clusterProfiler::dotplot(ego, showCategory = 10) 

## gprofiler for treemap
gprofiler_results_sex <- gost(query = sig_genes, 
                                  organism = "hsapiens",
                                  ordered_query = F, 
                                  exclude_iea = F, 
                                  user_threshold = 0.05, 
                                  correction_method = "g_SCS",
                                  domain_scope = "custom_annotated",
                                  custom_bg = all_genes)

## Order the results by p-adjusted value
gprofiler_res_sex<- gprofiler_results_sex$result
gprofiler_res_sex <- gprofiler_res_sex[order(gprofiler_res_sex$p_value), ]

## Extract only the 'GO' terms from the results
gprofiler_res_sex_GOs <- gprofiler_res_sex[grep('GO:', gprofiler_res_sex$term_id), ]

## Extract only GO IDs and p-values for downstream analysis
GOpval_sex <- gprofiler_res_sex_GOs[ , c("term_id", "p_value")]
write.table(GOpval_sex, "GOs_age1.txt", quote=FALSE, row.names = FALSE, col.names = FALSE)
```

### GSEA

```{r}
## remove NA values and any Entrez duplicates (due to gene ID conversion)
res_entrez <- subset(res_ids, entrez != "NA")
res_entrez <- res_entrez[which(duplicated(res_entrez$entrez) ==F), ]

## extract fold changes and label
foldchange <- res_entrez$log2FoldChange
names(foldchange) <- res_entrez$entrez

## order fold changes in decreasing order
foldchange <- sort(foldchange, decreasing = T)

## GSEA using gene sets associated with BP Gene Ontology terms
gseaGO <- gseGO(geneList = foldchange, 
              OrgDb = org.Hs.eg.db, 
              ont = 'BP', 
              minGSSize = 20, 
              pvalueCutoff = 0.05,
              verbose = FALSE) 

gseaGO_results <- gseaGO@result

## plot top 20 categories
dotplot(gseaGO, showCategory=20)

plot_top20 <- gseaGO_results[order(gseaGO_results$p.adjust), c("Description", "p.adjust", "NES")]
plot_top20 <- plot_top20[1:20, ] #top 20 GO terms by adjusted p-val

ggplot(data = plot_top20, 
       aes(x=reorder(Description, NES), y=NES, fill=p.adjust)) + 
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x="GO Term", y="Normalized Enrichment Score", 
       title="GSEA: Top 20 significant GO Terms", 
       subtitle = "Male+ Age 0-29 compared to Female+ Age 0-29") +
  theme(plot.title = element_text(hjust = 0.5),  plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_distiller(palette="GnBu")

```


## 30 - 59

### ORA

```{r}
## convert to tibble
res <- res_sex_age2s %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>%
  as_tibble()

## get entrez ids (ensembl) for the gene symbols in DE results
idx <- grch37$symbol %in% rownames(res_sex_age2s)
ids <- grch37[idx, ]

## remove duplicate IDs since gene names can map to more than one Ensembl ID since some genes change id over time
non_duplicates <- which(duplicated(ids$symbol) == FALSE)
ids <- ids[non_duplicates, ]

## merge ids with results
res_ids <- inner_join(res, ids, by=c("gene"="symbol"))

## for over-representation analysis need list of background genes(all genes tested for DE) and list of significant genes
all_genes <- as.character(res_ids$ensgene)
sig <- subset(res_ids, (padj<=0.05 & abs(log2FoldChange)>0.58))
sig_genes <- as.character(sig$ensgene)

## run GO enrichment analysis
ego <- enrichGO(gene = sig_genes, 
                universe = all_genes,
                keyType = "ENSEMBL",
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                qvalueCutoff = 0.05, 
                readable = TRUE)

## output results to a table
cluster_summary <- data.frame(ego)

##plot dotplot
clusterProfiler::dotplot(ego, showCategory = 20) 

## gprofiler for treemap
gprofiler_results_sex <- gost(query = sig_genes, 
                                  organism = "hsapiens",
                                  ordered_query = F, 
                                  exclude_iea = F, 
                                  user_threshold = 0.05, 
                                  correction_method = "g_SCS",
                                  domain_scope = "custom_annotated",
                                  custom_bg = all_genes)

## Order the results by p-adjusted value
gprofiler_res_sex<- gprofiler_results_sex$result
gprofiler_res_sex <- gprofiler_res_sex[order(gprofiler_res_sex$p_value), ]

## Extract only the 'GO' terms from the results
gprofiler_res_sex_GOs <- gprofiler_res_sex[grep('GO:', gprofiler_res_sex$term_id), ]

## Extract only GO IDs and p-values for downstream analysis
GOpval_sex <- gprofiler_res_sex_GOs[ , c("term_id", "p_value")]
write.table(GOpval_sex, "GOs_age1.txt", quote=FALSE, row.names = FALSE, col.names = FALSE)

```

## GSEA

```{r}
## remove NA values and any Entrez duplicates (due to gene ID conversion)
res_entrez <- subset(res_ids, entrez != "NA")
res_entrez <- res_entrez[which(duplicated(res_entrez$entrez) ==F), ]

## extract fold changes and label
foldchange <- res_entrez$log2FoldChange
names(foldchange) <- res_entrez$entrez

## order fold changes in decreasing order
foldchange <- sort(foldchange, decreasing = T)

## GSEA using gene sets associated with BP Gene Ontology terms
gseaGO <- gseGO(geneList = foldchange, 
              OrgDb = org.Hs.eg.db, 
              ont = 'BP', 
              minGSSize = 20, 
              pvalueCutoff = 0.05,
              verbose = FALSE) 

gseaGO_results <- gseaGO@result

## plot top 20 categories
dotplot(gseaGO, showCategory=20)

plot_top20 <- gseaGO_results[order(gseaGO_results$p.adjust), c("Description", "p.adjust", "NES")]
plot_top20 <- plot_top20[1:20, ] #top 20 GO terms by adjusted p-val
plot_top20 <- plot_top20[which(!is.na(plot_top20$p.adjust)),]

ggplot(data = plot_top20, 
       aes(x=reorder(Description, NES), y=NES, fill=p.adjust)) + 
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x="GO Term", y="Normalized Enrichment Score", 
       title="GSEA: Top 20 significant GO Terms", 
       subtitle = "Male+ Age 30-59 compared to Female+ Age 30-59") +
  theme(plot.title = element_text(hjust = 0.5),  plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_distiller(palette="GnBu")
```

## 60 - 100

### ORA

```{r}
## convert to tibble
res <- res_sex_age3s %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>%
  as_tibble()

## get entrez ids (ensembl) for the gene symbols in DE results
idx <- grch37$symbol %in% rownames(res_sex_age3s)
ids <- grch37[idx, ]

## remove duplicate IDs since gene names can map to more than one Ensembl ID since some genes change id over time
non_duplicates <- which(duplicated(ids$symbol) == FALSE)
ids <- ids[non_duplicates, ]

## merge ids with results
res_ids <- inner_join(res, ids, by=c("gene"="symbol"))

## for over-representation analysis need list of background genes(all genes tested for DE) and list of significant genes
all_genes <- as.character(res_ids$ensgene)
sig <- subset(res_ids, (padj<=0.05 & abs(log2FoldChange)>0.58))
sig_genes <- as.character(sig$ensgene)

## run GO enrichment analysis
ego <- enrichGO(gene = sig_genes, 
                universe = all_genes,
                keyType = "ENSEMBL",
                OrgDb = org.Hs.eg.db, 
                ont = "BP", 
                pAdjustMethod = "BH", 
                qvalueCutoff = 0.05, 
                readable = TRUE)

## output results to a table
cluster_summary <- data.frame(ego)

##plot dotplot
clusterProfiler::dotplot(ego, showCategory = 20) 

## gprofiler for treemap
gprofiler_results_sex <- gost(query = sig_genes, 
                                  organism = "hsapiens",
                                  ordered_query = F, 
                                  exclude_iea = F, 
                                  user_threshold = 0.05, 
                                  correction_method = "g_SCS",
                                  domain_scope = "custom_annotated",
                                  custom_bg = all_genes)

## Order the results by p-adjusted value
gprofiler_res_sex<- gprofiler_results_sex$result
gprofiler_res_sex <- gprofiler_res_sex[order(gprofiler_res_sex$p_value), ]

## Extract only the 'GO' terms from the results
gprofiler_res_sex_GOs <- gprofiler_res_sex[grep('GO:', gprofiler_res_sex$term_id), ]

## Extract only GO IDs and p-values for downstream analysis
GOpval_sex <- gprofiler_res_sex_GOs[ , c("term_id", "p_value")]
write.table(GOpval_sex, "GOs_age1.txt", quote=FALSE, row.names = FALSE, col.names = FALSE)

```

## GSEA

```{r}
## remove NA values and any Entrez duplicates (due to gene ID conversion)
res_entrez <- subset(res_ids, entrez != "NA")
res_entrez <- res_entrez[which(duplicated(res_entrez$entrez) ==F), ]

## extract fold changes and label
foldchange <- res_entrez$log2FoldChange
names(foldchange) <- res_entrez$entrez

## order fold changes in decreasing order
foldchange <- sort(foldchange, decreasing = T)

## GSEA using gene sets associated with BP Gene Ontology terms
gseaGO <- gseGO(geneList = foldchange, 
              OrgDb = org.Hs.eg.db, 
              ont = 'BP', 
              minGSSize = 20, 
              pvalueCutoff = 0.05,
              verbose = FALSE) 

gseaGO_results <- gseaGO@result

## plot top 20 categories
dotplot(gseaGO, showCategory=20)

plot_top20 <- gseaGO_results[order(gseaGO_results$p.adjust), c("Description", "p.adjust", "NES")]
plot_top20 <- plot_top20[1:20, ] #top 20 GO terms by adjusted p-val
plot_top20 <- plot_top20[which(!is.na(plot_top20$p.adjust)),]

ggplot(data = plot_top20, 
       aes(x=reorder(Description, NES), y=NES, fill=p.adjust)) + 
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x="GO Term", y="Normalized Enrichment Score", 
       title="GSEA: Top 20 significant GO Terms", 
       subtitle = "Male+ Age 60-100 compared to Female+ Age 60-100") +
  theme(plot.title = element_text(hjust = 0.5),  plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_distiller(palette="GnBu")
```